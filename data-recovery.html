<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据恢复 - 药品管理系统</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <style>
        .preview-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .preview-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80%;
            overflow-y: auto;
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
        }
        
        .close-btn:hover {
            color: #000;
        }
        
        .preview-data {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
<div id="app-container">
    <h1>数据恢复中心</h1>
    <p>扫描并预览浏览器中的药品管理数据</p>
    
    <div class="form-section">
        <h2>扫描结果</h2>
        <button onclick="scanAllData()">扫描数据</button>
        <div id="scanStatus" style="margin: 15px 0;"></div>
    </div>

    <!-- 数据列表 -->
    <div class="table-section" id="dataTable" style="display: none;">
        <h2>发现的数据</h2>
        <table>
            <thead>
                <tr>
                    <th>存储键</th>
                    <th>类型</th>
                    <th>药品数量</th>
                    <th>记录数量</th>
                    <th>大小</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="dataTableBody"></tbody>
        </table>
    </div>

    <div class="data-management">
        <a href="index.html" class="btn">返回主页</a>
    </div>
</div>

<!-- 预览模态框 -->
<div id="previewModal" class="preview-modal">
    <div class="preview-content">
        <div class="preview-header">
            <h3 id="previewTitle">数据预览</h3>
            <button class="close-btn" onclick="closePreview()">&times;</button>
        </div>
        <div id="previewData" class="preview-data"></div>
        <div style="margin-top: 15px;">
            <button id="restoreBtn" class="btn">恢复此数据</button>
        </div>
    </div>
</div>

<script>
    const DB_KEY = 'myDrugSystemData_v3';
    let currentPreviewKey = '';

    document.addEventListener('DOMContentLoaded', function() {
        scanAllData();
    });

    function scanAllData() {
        const statusDiv = document.getElementById('scanStatus');
        const tableDiv = document.getElementById('dataTable');
        const tbody = document.getElementById('dataTableBody');
        
        statusDiv.innerHTML = '正在扫描...';
        
        let foundData = [];
        
        // 扫描所有localStorage键
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            const data = localStorage.getItem(key);
            
            try {
                const parsed = JSON.parse(data);
                let drugCount = 0;
                let recordCount = 0;
                let dataType = '未知';
                
                // 检查是否是药品管理数据
                if (parsed.drugs && Array.isArray(parsed.drugs)) {
                    drugCount = parsed.drugs.length;
                    dataType = '药品管理数据';
                }
                if (parsed.stockRecords && Array.isArray(parsed.stockRecords)) {
                    recordCount = parsed.stockRecords.length;
                }
                
                // 如果包含药品或记录数据，或键名包含drug相关字符
                if (drugCount > 0 || recordCount > 0 || 
                    key.toLowerCase().includes('drug') || 
                    key.toLowerCase().includes('medicine')) {
                    foundData.push({
                        key: key,
                        type: dataType,
                        drugs: drugCount,
                        records: recordCount,
                        size: data.length,
                        data: data,
                        version: parsed.version || '未知'
                    });
                }
            } catch (e) {
                // 如果键名包含drug相关字符，也添加到列表（可能是其他格式的数据）
                if (key.toLowerCase().includes('drug') || key.toLowerCase().includes('medicine')) {
                    foundData.push({
                        key: key,
                        type: '文本数据',
                        drugs: 0,
                        records: 0,
                        size: data.length,
                        data: data,
                        version: '不适用'
                    });
                }
            }
        }
        
        if (foundData.length > 0) {
            statusDiv.innerHTML = `✅ 找到 ${foundData.length} 个相关数据`;
            statusDiv.style.color = 'green';
            
            tbody.innerHTML = '';
            foundData.forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.key}</td>
                    <td>${item.type}</td>
                    <td>${item.drugs}</td>
                    <td>${item.records}</td>
                    <td>${(item.size / 1024).toFixed(2)} KB</td>
                    <td>
                        <button onclick="previewData('${item.key}')">预览</button>
                        ${item.type === '药品管理数据' ? `<button onclick="restoreData('${item.key}')" class="btn-secondary" style="margin-left: 5px;">恢复</button>` : ''}
                    </td>
                `;
            });
            
            tableDiv.style.display = 'block';
        } else {
            statusDiv.innerHTML = '❌ 未找到任何药品管理相关数据';
            statusDiv.style.color = 'red';
            tableDiv.style.display = 'none';
        }
    }

    function previewData(key) {
        const data = localStorage.getItem(key);
        const modal = document.getElementById('previewModal');
        const title = document.getElementById('previewTitle');
        const previewDiv = document.getElementById('previewData');
        const restoreBtn = document.getElementById('restoreBtn');
        
        currentPreviewKey = key;
        title.textContent = `数据预览: ${key}`;
        
        try {
            const parsed = JSON.parse(data);
            
            let previewText = '';
            previewText += `存储键: ${key}\n`;
            previewText += `数据大小: ${(data.length / 1024).toFixed(2)} KB\n`;
            previewText += `数据版本: ${parsed.version || '未知'}\n\n`;
            
            if (parsed.drugs && Array.isArray(parsed.drugs)) {
                previewText += `=== 药品数据 (${parsed.drugs.length}种) ===\n`;
                parsed.drugs.slice(0, 5).forEach(drug => {
                    previewText += `• ${drug.name || '未知药品'} (${drug.spec || '无规格'}) - 库存: ${drug.currentStock || 0}\n`;
                });
                if (parsed.drugs.length > 5) {
                    previewText += `... 还有 ${parsed.drugs.length - 5} 种药品\n`;
                }
                previewText += '\n';
            }
            
            if (parsed.stockRecords && Array.isArray(parsed.stockRecords)) {
                previewText += `=== 库存记录 (${parsed.stockRecords.length}条) ===\n`;
                parsed.stockRecords.slice(0, 5).forEach(record => {
                    const type = record.type === 'IN' ? '入库' : '出库';
                    previewText += `• ${record.timestamp || '未知时间'} - ${type} ${record.quantity || 0}个\n`;
                });
                if (parsed.stockRecords.length > 5) {
                    previewText += `... 还有 ${parsed.stockRecords.length - 5} 条记录\n`;
                }
            }
            
            // 如果数据看起来是完整的药品管理数据，显示恢复按钮
            if (parsed.drugs && parsed.stockRecords) {
                restoreBtn.style.display = 'inline-block';
            } else {
                restoreBtn.style.display = 'none';
            }
            
            previewDiv.textContent = previewText;
        } catch (e) {
            // 显示原始数据预览
            const preview = data.length > 1000 ? data.substring(0, 1000) + '...\n\n(数据过长，仅显示前1000字符)' : data;
            previewDiv.textContent = `存储键: ${key}\n数据大小: ${(data.length / 1024).toFixed(2)} KB\n数据类型: 文本数据\n\n原始内容:\n${preview}`;
            restoreBtn.style.display = 'none';
        }
        
        modal.style.display = 'block';
    }

    function closePreview() {
        document.getElementById('previewModal').style.display = 'none';
    }

    function restoreData(key = null) {
        const keyToRestore = key || currentPreviewKey;
        
        if (!keyToRestore) {
            alert('❌ 没有指定要恢复的数据');
            return;
        }
        
        if (confirm(`确定要恢复数据 "${keyToRestore}" 吗？这将覆盖当前的药品管理数据！`)) {
            const data = localStorage.getItem(keyToRestore);
            if (data) {
                localStorage.setItem(DB_KEY, data);
                alert('✅ 数据恢复成功！');
                closePreview();
                setTimeout(() => {
                    scanAllData(); // 重新扫描以更新显示
                }, 500);
            } else {
                alert('❌ 恢复失败：数据不存在');
            }
        }
    }

    // 点击模态框背景关闭
    document.getElementById('previewModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closePreview();
        }
    });

    // 绑定恢复按钮事件
    document.getElementById('restoreBtn').addEventListener('click', function() {
        restoreData();
    });
</script>
</body>
</html>